# Thread Pool 이란?

![img](/img/thread_pool_01.png)

우선 평소에 우리가 사용하는 것들에 대해서 간단하게 짚고 넘어가는 시간을 가져보겠습니다.

- 프로그램 : 어떠한 목적을 달성하기 위해서 컴퓨터의 동작들을 하나로 모아 놓은 것
- 프로세스 : 컴퓨터가 현재 실행중인 프로그램

![img](/img/thread_pool_02.png)

스레드의 기본적인 정의는 CPU Core 의 실행 단위라고 할 수 있고 `Unit Of execution` 이라고도 많이 불리는데요    
우리가 프로세스의 작업을 -> 스레드 단위로 나눠서 할 수 있는데 이렇게 쓰레드 단위로 나눠진 프로세스 작업들을 CPU Core 가 처리를 할 수 있게 되죠.  
그렇다는 것은 우리가 쓰레드를 사용하게 됨으로써 `하나의 프로세스에서 두 가지 이상 작업`을 동시에 실행이 가능하다는 것을 의미합니다.  

그러면 단순히 스레드만 사용해서 동시에 여러 작업을 실행시킬 수 있는 프로그램을 만들 수 있을까?

![img](/img/thread_pool_03.png)

이미지 처럼 자바로 만든 프로세스가 있는데 이 프로세스는 요청이 올 때마다 새로운 쓰레드를 생성해 가지고 작업을 처리하고 처리가 끝나면 쓰레드를 없애는 방식으로 동작하는 프로세스가 하나 있습니다.    
쓰레드를 이렇게 사용하게 되면 문제점은 `첫번째로 쓰레드의 생성 비용이 크기 때문에 요청에 대한 응답시간이 늘어나게 됩니다.`

![img](/img/thread_pool_04.png)

자바같은 경우 `One-to-One Threading-Model 로 쓰레드를 생성`하게 되는데  
이는 `유저 쓰레드 하나가 생길 때 그에 해당하는 OS 쓰레드를 하나를 꼭 연결`해줘야 된다는 뜻입니다.  
그래서 새로운 쓰레드를 생성한다는 것은 OS 커널의 작업이 동반된다는 것을 의미하고 그 말은 새로운 쓰레드를 생성할 때 생성비용이 많이 들게됩니다.  

- 용어 설명)
  - 유저 쓰레드(user thread) : 운영 체제에서 직접 관리하지 않는 쓰레드를 의미합니다. 이러한 쓰레드는 운영 체제에서 제공하는 쓰레드 API를 사용하여 사용자 애플리케이션에서 관리합니다.
  - OS 쓰레드(OS thread) : 운영 체제에서 직접 관리하는 쓰레드를 의미합니다. 이러한 쓰레드는 운영 체제의 스케줄러를 통해 실행되며, 운영 체제의 자원을 사용할 수 있습니다.

유저 쓰레드의 간단한 예를 생각해보면, 
사용자 애플리케이션에서 작업을 수행하는 경우를 들 수 있습니다. 
예를 들어, 웹 브라우저를 사용하여 웹 페이지를 불러오는 경우 웹 페이지 로딩, 이미지 다운로드, 스크립트 실행 등의 작업을 유저 쓰레드를 사용하여 수행할 수 있습니다. 
이러한 유저 쓰레드는 운영 체제에서 직접 관리하지 않고 사용자 애플리케이션에서 관리합니다.
OS 쓰레드의 간단한 예를 생각해보면, 운영 체제에서 내부적으로 수행하는 작업을 들 수 있습니다. 
예를 들어, 운영 체제의 스케줄러가 프로세스나 쓰레드를 실행하는 경우, 운영 체제가 실행 중인 프로세스나 쓰레드를 관리하는 작업을 OS 쓰레드를 사용하여 수행할 수 있습니다.

![img](/img/thread_pool_05.png)

두번째로 쓰레드가 너무 많아졌을 때 여러가지 문제가 발생하게 되는데 요청이 계속해서 들어오게 되면 새로운 쓰레드를 만들게 되고 무제한으로 쓰레드가 쌓이게 됩니다.  
이렇게 되면 메모리를 많이 차지하게 되고 메모리 문제가 발생할 가능성이 높아집니다.    
Context-Switching 더 자주 발생하기 때문에 CPU 오버헤드가 증가하게 됩니다.  
결국 두가지의 문제로 인해 하드웨어 쪽으로 무리가 발생하고 프로그램이 멈출 수도 있습니다.  

용어 설명)
Context-Switching은 운영 체제에서 여러 프로세스나 쓰레드를 실행할 때, 운영 체제가 현재 실행 중인 프로세스나 쓰레드의 상태(context)를 저장하고 다른 프로세스나 쓰레드를 실행하는 것을 의미합니다.   
이때 저장되는 상태는 프로세스나 쓰레드가 사용하는 레지스터, 메모리 내용, 파일 디스크립터 등이 포함됩니다.  
Context-Switching은 `운영 체제는 여러 프로세스나 쓰레드를 동시에 실행할 수 있도록` 하며, 프로세스나 쓰레드는 자신이 실행되는 동안 전체 시스템의 자원을 사용하는 것처럼 느낄 수 있도록 합니다.  
Context-Switching는 운영체제 성능에 영향을 줄 수 있으며, `계산량을 줄이기 위한 최적화를 수행하며 가능하면 줄이는 것이 좋다.`  

추가 간단 예시)
Context-Switching의 간단한 예를 생각해보면, 운영 체제는 프로세스 A와 프로세스 B를 실행 중입니다.  
프로세스 A는 연산을 수행하는 중이고 프로세스 B는 대기 상태입니다. 운영 체제는 프로세스 B에게 CPU 사용 권한을 부여하기 위해 프로세스 A의 상태를 저장하고 프로세스 B를 실행합니다.   
이때, 운영 체제는 프로세스 A가 사용하던 레지스터, 메모리 내용, 파일 디스크립터 등을 저장하고 프로세스 B가 사용할 수 있도록 설정합니다. 이를 Context-Switching이라고 합니다.  
Context-Switching은 프로세스나 쓰레드 실행 순서를 변경하는 것이므로, 운영 체제의 스케줄러에 의해 이루어지며, 이는 운영 체제의 스케줄링 알고리즘에 따라 달라질 수 있다.  

그럼 이것을 해결하는 방법은?

![img](/img/thread_pool_06.png)

Thread Pool 입니다.   
Thread Pool 이라는 것은 `허용된 개수 안에서 사용하도록 제한하는 시스템`을 얘기하는데 풀 이라는 것처럼 웅덩이, 수영장 같은 곳에다가 일정량의 쓰레드를 모아놓고 이 `범위 안에 있는 쓰레드만 작업에 사용하는 것을 의미`합니다.

![img](/img/thread_pool_07.png)

Thread Pool에서 `작업을 할 쓰레드`들 그리고 `작업 큐`로 이루어 져있습니다.  
Thread Pool에 작업 요청이 들어오면 작업 큐에 작업들이 쌓이게 되고 Thread Pool 안의 쓰레드들이 작업 큐에 있는 작업을 빼서 처리하게 됩니다.  
Thread Pool의 특징은 `정해진 양 만큼의 쓰레드를 사용하는 것도 특징`이지만 `한 번 사용된 쓰레드가 작업이 끝났을 때 없어지지 않고 재사용이 가능`하다는게 또 특징입니다.   

![img](/img/thread_pool_08.png)

이렇게 Thread Pool을 사용하게 되면 앞서 봤던 두 가지 문제를 해결할 수가 있는데  
`쓰레드 비용이 크게 든다는 것은 미리 만들어 놓은 쓰레드를 재사용`할 수 있기 때문에 새로운 쓰레드를 생성하는 비용을 줄일 수가 있고  
메모리 문제나 컨텍스트 스위칭으로 인한 CPU 오버헤드의 증가는 사용할 `쓰레드 기술을 제한해 놓기 때문에 무제한적으로 쓰레드가 생성되는 것을 방지`함으로써 이런 문제들을 해결할 수 있습니다.  

결론은 여러개의 작업을 동시에 처리하면서도 안정적으로 처리하고 싶을 때 Thread Pool은 효과적이다.